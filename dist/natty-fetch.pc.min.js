/*! natty-fetch.pc.min.js v2.6.1 | MIT License | fushan | https://github.com/jias/natty-fetch */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("natty-storage")):"function"==typeof define&&define.amd?define(["natty-storage"],e):t.nattyFetch=e(t.nattyStorage)}(this,function(t){"use strict";function e(t){return t}function r(t){return function(){for(var e=arguments,r=t(e[0],e[1]),n=2,o=e.length;n<o;n++)r=t(r,e[n]);return r}}function n(t){return!!t.match(W)}function o(t){return!!t.match(B)}function i(t){return typeof t===V}function a(t){return typeof t===z}function s(t){return typeof t===K}function c(t){return s(t)?t():t}function u(t){return!isNaN(t)&&typeof t===Q}function l(t){return typeof t===Y&&t!==F}function p(t){return t!==F&&t===t.window}function f(t){return t!==F&&l(t)&&!p(t)&&Object.getPrototypeOf(t)===Object.prototype}function d(t){var e=0;for(var r in t)t.hasOwnProperty(r)&&e++;return 0===e}function h(t){return A.call(t)===D}function m(t){var e=P.createElement("a");return e.href=t,!J||":"!==e.protocol&&""!==e.protocol?H.hostname!==e.hostname||H.port!==e.port||H.protocol!==e.protocol:""!==e.hostname&&(H.hostname!==e.hostname||H.port!==e.port)}function g(t,e,r){void 0===t&&(t={}),void 0===e&&(e={}),void 0===r&&(r=U);for(var n in e)e.hasOwnProperty(n)&&void 0!==e[n]&&(r===T?h(e[n])?t[n]=[].concat(e[n]):f(e[n])?t[n]=Z({},e[n]):t[n]=e[n]:t[n]=e[n]);return t}function v(t,e){void 0===t&&(t={}),void 0===e&&(e={});var r=new FormData,n=function(t){if(t.constructor===FormData)for(var e=t.entries(),n=e.next();!n.done;)r.set(n.value[0],n.value[1]),n=e.next();else for(var o in t)r.set(o,t[o])};return n(t),n(e),r}function y(t){return g({},t,!0)}function b(t,e){var r,n;if(h(t)){for(r=0,n=t.length;r<n;r++)if(e.call(t[r],t[r],r)===!1)return}else for(r in t)if(e.call(t[r],t[r],r)===!1)return}function j(t){var e,r={},n=[];for(e in t)t.hasOwnProperty(e)&&(n.push(e),f(t[e])&&(t[e]=j(t[e])));n.sort();for(var o=0,i=n.length;o<i;o++)r[n[o]]=t[n[o]];return r}function k(t,e,r,n){var o,i=h(e),a=f(e);b(e,function(e,s){o=A.call(e),n&&(s=r?n:n+"["+(a||o===X||o===D?s:"")+"]"),!n&&i?t.add(e.name,e.value):o==D||!r&&o==X?k(t,e,r,s):t.add(s,e)})}function w(t,e){var r=[];return r.add=function(t,e){s(e)&&(e=e()),e==F&&(e=""),r.push(I(t)+"="+I(e))},k(r,t,e),r.join("&").replace(/%20/g,"+")}function x(t){return decodeURIComponent(t.replace(/\+/g," "))}function _(t,e,r,n){r&&(e[i(r)?"_stamp":r]=+new Date);var o=w(e,n);return o?t+(~t.indexOf("?")?"&":"?")+o:t}function S(t){void 0===t&&(t=6);for(var e="",r=0;r<t;r++)e+=tt.charAt(Math.floor(Math.random()*tt.length));return e}function O(t,e,r){return void 0===r&&(r=!1),r&&N&&console.log(t+"\n"+JSON.stringify(e,null,2)),t}function q(t){t=Z({},dt,t);var e=m(t.url),r=new XMLHttpRequest;ct&&e&&(r=new XDomainRequest),r._completed=U,ft(r,t,e),r.open(t.method,_(t.url,Z({},t.urlMark?t.mark:{},t.method===rt?t.data:{},t.query),t.urlStamp,t.traditional),t.async),ct||(r.withCredentials=i(t.withCredentials)?t.withCredentials:e);var n,o=pt(r,t);return n=t.data&&t.data.constructor===FormData?t.data:o["Content-Type"]&&~o["Content-Type"].indexOf("application/x-www-form-urlencoded")?w(t.data,t.traditional):JSON.stringify(t.data),r.send(t.method===rt?F:n===F?F:n),r}function C(t){t=Z({},kt,t);var e,r=t.callbackName=t.callbackName.replace(/\{id\}/,S(6)),n=t.complete;t.complete=function(){yt(e),n()},ht[r]=function(e){ht[r]=F,t.success(e),t.complete()};var o,i=_(t.url,Z((o={},o[t.flag]=r,o),t.urlMark?t.mark:{},t.data),t.urlStamp,t.traditional);return e=jt(i,t),{abort:function(){ht[r]=function(){ht[r]=F},yt(e)}}}function E(t){return _t+t}t="default"in t?t["default"]:t;var R="undefined"!=typeof window,N="undefined"!=typeof console,P=R?document:null,I=encodeURIComponent,F=null,T=!0,U=!T,M="undefined",L="",A=Object.prototype.toString,D="[object Array]",X="[object Object]",G={dummy:T};G.then=G["catch"]=function(){return G};var H,J=R&&(!!window.ActiveXObject||"ActiveXObject"in window),W=/^(https?:)?\/\//,B=/^[\.\/]/,V="boolean",z="string",K="function",Q="number",Y="object";P&&(H=P.createElement("a"),H.href=location.href);var Z=r(g),$=r(v),tt="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",et=Object.freeze({hasWindow:R,hasConsole:N,doc:P,escape:I,NULL:F,TRUE:T,FALSE:U,UNDEFINED:M,EMPTY:L,dummyPromise:G,isIE:J,noop:e,redo:r,isAbsoluteUrl:n,isRelativeUrl:o,isBoolean:i,isString:a,isFunction:s,runAsFn:c,isNumber:u,isObject:l,isWindow:p,isPlainObject:f,isEmptyObject:d,isArray:h,isCrossDomain:m,extend:Z,fdAssign:$,deepCopy:y,each:b,sortPlainObjectKey:j,serialize:k,param:w,decodeParam:x,appendQueryString:_,makeRandom:S,makeMessage:O}),rt="GET",nt="script",ot="xml",it="json",at=M!==typeof XMLHttpRequest?new XMLHttpRequest:{},st=M!==typeof XDomainRequest,ct=R?!("withCredentials"in at)&&st:F,ut=R?"withCredentials"in at||st:F,lt={"*":"*/*",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript",json:"application/json, text/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},pt=function(t,e){if(!t.setRequestHeader)return{};var r={Accept:lt[e.accept]};m(e.url)||(r["X-Requested-With"]="XMLHttpRequest"),e.fd||"POST"!==e.method||r["Content-Type"]||(r["Content-Type"]="application/x-www-form-urlencoded"),Z(r,e.header);for(var n in r)t.setRequestHeader(n,r[n]);return r},ft=function(t,r,n){var o=function(){t._completed||(t._completed=!0,r.complete(),t._aborted=null,delete t._aborted)},i=function(){if(!t._completed){var e=t.responseText;switch(r.accept){case it:try{e=JSON.parse(e)}catch(t){console.warn("The response can NOT be parsed to JSON object.",e)}break;case nt:(0,eval)(e);break;case ot:e=t.responseXML}r.success(e,t),o()}},a=function(){t._completed||(r.error(t.status,t),o())},s=function(){t._completed||(r.abort(),o())};ct&&n?t.onload=i:t.onreadystatechange=function(){t._completed||4==t.readyState&&(t.status>=200&&t.status<300||304===t.status?i():!t._aborted&&a())},t.onerror=a;var c=t.abort;t.abort=function(){t._completed||(t._aborted=!0,J||c.call(t),s())},t.onprogress=t.ontimeout=e},dt={async:T,url:"",mark:{},urlMark:T,method:rt,accept:"*",data:F,header:{},withCredentials:F,urlStamp:T,success:e,error:e,complete:e,abort:e,query:{},log:U,traditional:U};q.fallback=ct,q.supportCORS=ut;var ht=R?window:F,mt=R?document:F,gt="script",vt=R?navigator.userAgent.indexOf("MSIE 8.0")>-1:U,yt=function(t){vt&&t.readyState?t.onreadystatechange=F:t.onerror=F,t.parentNode.removeChild(t),t=F},bt=F,jt=function(t,e){var r=mt.createElement(gt);return r.type="text/javascript",r.src=t,r.async=T,e.crossOrigin&&(r.crossorigin=!0),vt&&r.readyState?r.onreadystatechange=function(){"loaded"===r.readyState&&ht[e.callbackName]&&(ht[e.callbackName]=F,e.error(),e.complete())}:(r.onerror=function(){ht[e.callbackName]=F,e.error(t+" 请求出错"),e.complete()},r.onload=function(){setTimeout(function(){ht[e.callbackName]&&(e.error("'"+t+"' 返回值错误"),e.complete())},0)}),bt=bt||mt.getElementsByTagName("head")[0],bt.insertBefore(r,bt.firstChild),r},kt={url:"",mark:{},urlMark:T,data:{},urlStamp:T,success:e,error:e,complete:e,log:U,flag:"callback",callbackName:"jsonp{id}",traditional:U,crossOrigin:U},wt=function(t){var e=t.path,r=t.config,n=t.api,o=t.contextId;this._rid=[o,e,S(6)].join("-"),this._path=e,this.config=r,this.storage=n.storage,this.contextId=o,this.pending=U,this._requester=F};wt.prototype.send=function(t){var e=this,r=t.vars,n=t.onSuccess,o=t.onError,i=t.onComplete;this.vars=r,this.onSuccess=n,this.onError=o,this.onComplete=i;var a=this,s=a.config;s.willFetch(r,s,"remote"),this.pending=T,s.customRequest?this._requester=s.customRequest(r,s,function(t,r){t?e.processResponse(r):e.onError(r)}):s.jsonp?this._requester=this.jsonp():this._requester=this.ajax(),r.requester=this._requester,0!==s.timeout&&setTimeout(function(){if(e.pending){e.abort();var t={timeout:T,message:O("Request Timeout",{context:e.contextId,api:""+r.api,timeout:s.timeout+"ms"},s.log)};e.onError(t)}},s.timeout)},wt.prototype.processResponse=function(t){var e=this,r=e.config,n=e.vars;if(r.didFetch(n,r),t=r.fit(t,n),t.success){var o=r.process(t.content,n);this.onSuccess(o)}else{var i=Z({message:"Error in request: "+this._path},t.error);this.onError(i)}},wt.prototype.getFinalUrl=function(){var t=this,e=t.config,r=t.vars,n=e.mock?e.mockUrl:e.url;if(!n)return L;var o=e.mock?"mockUrlPrefix":"urlPrefix",i=e.mock?"mockUrlSuffix":"urlSuffix",a=e[o]?e[o]:L,s=e[i]?e[i]:L;if(n=a+n+s,e.rest){var c=r.data;for(var u in c)c.hasOwnProperty(u)&&~u.indexOf(":")&&(n=n.replace(new RegExp("\\/"+u),"/"+c[u]),delete c[u])}return n},wt.prototype.ajax=function(){var t=this,e=this,r=e.config,n=e.vars,o=this.getFinalUrl();return q({async:r.async,traditional:r.traditional,urlStamp:r.urlStamp,mark:n.mark,urlMark:r.urlMark,log:r.log,url:o,fd:r.fd,method:r.method,data:n.data,header:r.header,query:r.query,withCredentials:r.withCredentials,accept:"json",success:function(e){t.processResponse(e)},error:function(e){var i={status:e,message:O("Request Error(Status: "+e+")",{status:e,context:t.contextId,api:n.api,url:o},r.log)};t.onError(i)},complete:function(){t.onComplete(),t.pending=U,t._requester=F}})},wt.prototype.jsonp=function(){var t=this,e=this,r=e.config,n=e.vars,o=this.getFinalUrl();return C({traditional:r.traditional,log:r.log,mark:n.mark,urlMark:r.urlMark,url:o,data:n.data,urlStamp:r.urlStamp,flag:r.jsonpFlag,callbackName:r.jsonpCallbackName,crossOrigin:r.jsonpCrossOrigin,success:function(e){t.processResponse(e)},error:function(e){var i={message:O("Request Error(Not Accessable JSONP)，"+e,{context:t.contextId,api:n.api,url:o},r.log)};t.onError(i)},complete:function(){t.onComplete(),t.pending=U,t._requester=F}})},wt.prototype.abort=function(){this._requester&&this._requester.abort()};var xt=function(t){var e=this;e.promise=new t(function(t,r){e._resolve=t,e._reject=r})};xt.prototype.resolve=function(t){this._resolve.call(this.promise,t)},xt.prototype.reject=function(t){this._reject.call(this.promise,t)};var _t="_",St={on:function(){var t=this,e=arguments;if("string"==typeof e[0]&&"function"==typeof e[1]){var r=E(e[0]);this[r]=this[r]||[],this[r].push(e[1])}else if("object"==typeof e[0]){var n=e[0];for(var o in n)n.hasOwnProperty(o)&&t.on(o,n[o])}},off:function(t,e){if(t=E(t),e){var r=this[t];r.splice(r.indexOf(e),1),this[t].length||delete this[t]}else delete this[t]},fire:function(t,e,r){var n=this,o=this[E(t)];if(!o)return"NO_EVENT";for(var i=0,a=o.length;i<a;i++)o[i].apply(r||n,[].concat(e))},hasEvent:function(t){return!!this[E(t)]}},Ot=function(){var t=this,r=t.api;r.loop=function(t,n,o){if(void 0===n&&(n=e),void 0===o&&(o=e),!t.duration||!u(t.duration))throw new Error("Illegal `duration` value for `startLoop` method.");var i=F,a=function(){clearTimeout(i),i=F,a.looping=U},s=function(){a.looping=T,r(t.data,t.header).then(n,o),i=setTimeout(function(){s()},t.duration)};return s(),a}},qt=function(){var t=this,r=this,n=r.api;n.soon=function(r,o,i){void 0===o&&(o=e),void 0===i&&(i=e);var a=y(t.config),s=t.makeVars(r);if(n.storageUseable){var c=n.storage.has(s.queryString);c.has&&o({fromStorage:T,content:c.value})}t.send(s,a,{}).then(function(t){o({fromStorage:U,content:t})},function(t){i(t)})["catch"](function(t){N&&console.error(t)})}},Ct={async:T,data:{},didFetch:e,fit:e,header:{},ignoreSelfConcurrent:U,jsonp:U,jsonpCrossOrigin:U,log:U,method:"GET",mock:U,mockUrl:L,mockUrlPrefix:L,mockUrlSuffix:L,process:e,Promise:R?window.Promise:F,rest:U,retry:0,query:{},customRequest:F,timeout:0,traditional:U,url:L,urlPrefix:L,urlMark:!0,urlStamp:T,urlSuffix:L,withCredentials:F,willFetch:e,storage:U,plugins:U},Et=Z,Rt=c,Nt=i,Pt=y,It=$,Ft=h,Tt=s,Ut=j,Mt=d,Lt=f,At=G,Dt=a,Xt=F,Gt=T,Ht=U,Jt=N,Wt=S,Bt=Et({},Ct),Vt=function(t,e,r,n){var o=this;this._path=t,this.contextConfig=r,this.contextId=n,this._pendingList=[],this.storage=Xt,this.config=this.processAPIOptions(e),this.api=function(t,e){var r=Pt(o.config);if(Et(r.header,e),o._pendingList.length){if(r.ignoreSelfConcurrent)return At;r.overrideSelfConcurrent&&o._pendingList[0].abort()}var n=o.makeVars(t);if(o.api.storageUseable){var i=o.api.storage.has(n.queryString);return i.has?new r.Promise(function(t){t(i.value)}):0===r.retry?o.send(n,r):o.sendWithRetry(n,r)}return 0===r.retry?o.send(n,r):o.sendWithRetry(n,r)},this.api.config=this.config,this.api.hasPending=function(){return!!o._pendingList.length},this.api.abort=function(){Jt&&console.warn("`abort` method will be deleted later!");for(var t=0,e=o._pendingList.length;t<e;t++)o._pendingList[t].abort()},this.initStorage();for(var i=Ft(this.config.plugins)?this.config.plugins:[],a=0,s=i.length;a<s;a++)Tt(i[a])&&i[a].call(o,o)};Vt.prototype.makeVars=function(t){var e=this,r=e.config,n={mark:{_api:this._path,_mock:r.mock},api:this._path,mock:r.mock,contextId:this.contextId};return t=(t||{}).constructor===FormData||(r.data||{}).constructor===FormData?It(Rt(r.data),Rt(t)):Et({},Rt(r.data),Rt(t)),n.data=t,this.api.storageUseable&&(n.queryString=Mt(t)?"no-query-string":JSON.stringify(Ut(t))),n},Vt.prototype.send=function(t,e){var r=this,n=new wt({path:this._path,config:e,api:this.api,contextId:this.contextId});this._pendingList.push(n);var o=new xt(e.Promise);return n.send({vars:t,onSuccess:function(n){r.api.storageUseable&&r.api.storage.set(t.queryString,n),o.resolve(n),St.fire("g.resolve",[n,e],e),St.fire(r.contextId+".resolve",[n,e],e)},onError:function(n){o.reject(n),St.fire("g.reject",[n,e,t],e),St.fire(r.contextId+".reject",[n,e,t],e)},onComplete:function(){for(var t,e=0,o=r._pendingList.length;e<o;e++)if(r._pendingList[e]===n){t=e;break}void 0!==t&&r._pendingList.splice(t,1)}}),o.promise},Vt.prototype.sendWithRetry=function(t,e){var r=this;return new e.Promise(function(n,o){var i=0,a=function(){t.mark._retryTime=i,r.send(t,e).then(function(t){n(t)},function(t){i===e.retry?o(t):(i++,a())})};a()})},Vt.prototype.processAPIOptions=function(t){var e=[].concat(this.contextConfig.plugins||[],t.plugins||[]),r=Et({},this.contextConfig,t,{plugins:e});return Ft(t.jsonp)&&(r.jsonp=Nt(t.jsonp[0])?t.jsonp[0]:Ht,r.jsonp&&(r.jsonpFlag=t.jsonp[1],r.jsonpCallbackName=t.jsonp[2])),!r.mock&&r.url.match(/\.jsonp(\?.*)?$/)&&(r.jsonp=Gt),r},Vt.prototype.initStorage=function(){var e=this,r=e.config;if(r.storage===Gt&&(r.storage={type:"variable"}),this.api.storageUseable=Lt(r.storage)&&("GET"===r.method||r.jsonp)&&t.supportStorage&&(["localStorage","sessionStorage"].indexOf(r.storage.type)>-1||"variable"===r.storage.type),this.api.storageUseable){if("localStorage"===r.storage.type){if(!r.storage.hasOwnProperty("key")||!r.storage.key)throw new Error("`key` is required when `storage.type` is `localStorage`.")}else r.storage.key=r.storage.key||[this.contextId,this._path].join("_");this.api.storage=t(Et({},r.storage,{tag:[r.storage.tag,r.jsonp?"jsonp":r.method,r.url].join("_")}))}};var zt=function(e,r){Dt(e)?r=r||{}:(r=e||{},e="c"+Wt());var n=t({type:"variable",key:e}),o={};o.api=n.get(),o._contextId=e;var i=[].concat(Bt.plugins||[],r.plugins||[]);return o._config=Et({},Bt,r,{plugins:i}),o.create=function(t,r){var i=2===arguments.length&&Dt(t);i||(r=t);for(var a in r)r.hasOwnProperty(a)&&n.set(i?t+"."+a:a,new Vt(i?t+"."+a:a,Rt(r[a]),o._config,e).api);o.api=n.get()},o.on=function(t,e){if(Tt(e))return St.on(o._contextId+"."+t,e),o},o},Kt={};return Kt.create=function(t){return new Vt("nattyFetch",Rt(t),Ct,"global").api},Et(Kt,{onlyForModern:!1,version:"2.6.1",_util:et,_event:St,_ajax:q,context:zt,setGlobal:function(t){return Bt=Et({},Ct,t),this},getGlobal:function(t){return t?Bt[t]:Bt},on:function(t,e){if(Tt(e))return St.on("g."+t,e),this},plugin:{loop:Ot,soon:qt}}),Kt.setGlobal(Ct),Kt});
//# sourceMappingURL=natty-fetch.pc.min.js.map
